version: api.keploy.io/v1beta1
kind: SQL
name: test-198-0
spec:
    metadata:
        name: SQL
        operation: PrepareContext
        query: '"SELECT * FROM lists WHERE (CASE WHEN $1 != '''' THEN optin=$1::list_optin ELSE TRUE END) AND (CASE WHEN $2::INT[] IS NOT NULL THEN id = ANY($2::INT[]) WHEN $3::UUID[] IS NOT NULL THEN uuid = ANY($3::UUID[]) END) ORDER BY name;"'
        type: SQL_DB
    type: error
    int: 0
    error:
        - nil
---
version: api.keploy.io/v1beta1
kind: SQL
name: test-198-1
spec:
    metadata:
        name: SQL
        operation: PrepareContext.NumInput
        type: SQL_DB
    type: int
    int: 3
    error: []
---
version: api.keploy.io/v1beta1
kind: SQL
name: test-198-2
spec:
    metadata:
        arguments: '[{ 1 double} { 2 {3}} { 3 <nil>}]'
        name: SQL
        operation: QueryContext
        type: SQL_DB
    type: error
    int: 0
    error:
        - nil
---
version: api.keploy.io/v1beta1
kind: SQL
name: test-198-3
spec:
    metadata:
        name: SQL
        operation: QueryContext.Close
        type: SQL_DB
    type: table
    table:
        cols:
            - name: id
              type: int64
              precision: 0
              scale: 0
            - name: uuid
              type: '[]uint8'
              precision: 0
              scale: 0
            - name: name
              type: string
              precision: 0
              scale: 0
            - name: type
              type: '[]uint8'
              precision: 0
              scale: 0
            - name: optin
              type: '[]uint8'
              precision: 0
              scale: 0
            - name: tags
              type: <nil>
              precision: 0
              scale: 0
            - name: created_at
              type: time.Time
              precision: 0
              scale: 0
            - name: updated_at
              type: time.Time
              precision: 0
              scale: 0
        rows:
            - '[`3` | `[100 102 54 57 101 51 51 100 45 101 49 102 52 45 52 102 57 98 45 97 53 51 98 45 57 101 48 53 57 51 57 54 99 102 51 97]` | `optin` | `[112 114 105 118 97 116 101]` | `[100 111 117 98 108 101]` | `<nil>` | `"2022-12-23T10:25:59.03121Z"` | `"2022-12-23T10:25:59.03121Z"` | ]'
            - '[`3` | `[100 102 54 57 101 51 51 100 45 101 49 102 52 45 52 102 57 98 45 97 53 51 98 45 57 101 48 53 57 51 57 54 99 102 51 97]` | `optin` | `[112 114 105 118 97 116 101]` | `[100 111 117 98 108 101]` | `<nil>` | `"2022-12-23T10:25:59.03121Z"` | `"2022-12-23T10:25:59.03121Z"` | ]'
    int: 0
    error:
        - nil
        - EOF
        - nil
---
version: api.keploy.io/v1beta1
kind: SQL
name: test-198-4
spec:
    metadata:
        name: SQL
        operation: PrepareContext.Close
        type: SQL_DB
    type: error
    int: 0
    error:
        - nil
---
version: api.keploy.io/v1beta1
kind: SQL
name: test-198-5
spec:
    metadata:
        name: SQL
        operation: PrepareContext
        query: '"WITH campLists AS ( SELECT lists.id AS list_id, campaign_id, optin FROM lists INNER JOIN campaign_lists ON (campaign_lists.list_id = lists.id) WHERE lists.id = ANY($14::INT[]) ), tpl AS ( SELECT (CASE WHEN $13 = 0 THEN id ELSE $13 END) AS id FROM templates WHERE is_default IS TRUE ), counts AS ( SELECT COALESCE(COUNT(id), 0) as to_send, COALESCE(MAX(id), 0) as max_sub_id FROM subscribers LEFT JOIN campLists ON (campLists.campaign_id = ANY($14::INT[])) LEFT JOIN subscriber_lists ON ( subscriber_lists.status != ''unsubscribed'' AND subscribers.id = subscriber_lists.subscriber_id AND subscriber_lists.list_id = campLists.list_id AND (CASE WHEN campLists.optin = ''double'' THEN subscriber_lists.status = ''confirmed'' ELSE true END) ) WHERE subscriber_lists.list_id=ANY($14::INT[]) AND subscribers.status=''enabled'' ), camp AS ( INSERT INTO campaigns (uuid, type, name, subject, from_email, body, altbody, content_type, send_at, headers, tags, messenger, template_id, to_send, max_subscriber_id) SELECT $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, (SELECT id FROM tpl), (SELECT to_send FROM counts), (SELECT max_sub_id FROM counts) RETURNING id ) INSERT INTO campaign_lists (campaign_id, list_id, list_name) (SELECT (SELECT id FROM camp), id, name FROM lists WHERE id=ANY($14::INT[])) RETURNING (SELECT id FROM camp);"'
        type: SQL_DB
    type: error
    int: 0
    error:
        - nil
---
version: api.keploy.io/v1beta1
kind: SQL
name: test-198-6
spec:
    metadata:
        name: SQL
        operation: PrepareContext.NumInput
        type: SQL_DB
    type: int
    int: 14
    error: []
---
version: api.keploy.io/v1beta1
kind: SQL
name: test-198-7
spec:
    metadata:
        arguments: "[{ 1 aa1d4384-b640-40ea-bb49-dedf00017871} { 2 optin} { 3 sample-optin} { 4 sample-optin} { 5 ritik@keploy.io} { 6 \n\n<p>Hi {{.Subscriber.FirstName }}</p>\n<p>You have been added to the following lists:</p>\n<ul>\n    \n        \n            <li>Private list</li>\n        \n    \n</ul>\n<p>\n    <a class=\"button\" href=\"{{ OptinURL }}l=df69e33d-e1f4-4f9b-a53b-9e059396cf3a\">Confirm subscription</a>\n</p>\n} { 7 <nil>} { 8 richtext} { 9 <nil>} { 10 []} { 11 <nil>} { 12 email} { 13 1} { 14 {3}}]"
        name: SQL
        operation: QueryContext
        type: SQL_DB
    type: error
    int: 0
    error:
        - nil
---
version: api.keploy.io/v1beta1
kind: SQL
name: test-198-8
spec:
    metadata:
        name: SQL
        operation: QueryContext.Close
        type: SQL_DB
    type: table
    table:
        cols:
            - name: id
              type: int64
              precision: 0
              scale: 0
        rows:
            - '[`12` | ]'
    int: 0
    error:
        - nil
        - nil
---
version: api.keploy.io/v1beta1
kind: SQL
name: test-198-9
spec:
    metadata:
        name: SQL
        operation: PrepareContext.Close
        type: SQL_DB
    type: error
    int: 0
    error:
        - nil
---
version: api.keploy.io/v1beta1
kind: SQL
name: test-198-10
spec:
    metadata:
        name: SQL
        operation: PrepareContext
        query: '"SELECT campaigns.*, COALESCE(templates.body, (SELECT body FROM templates WHERE is_default = true LIMIT 1)) AS template_body FROM campaigns LEFT JOIN templates ON (templates.id = campaigns.template_id) WHERE CASE WHEN $1 > 0 THEN campaigns.id = $1 ELSE uuid = $2 END;"'
        type: SQL_DB
    type: error
    int: 0
    error:
        - nil
---
version: api.keploy.io/v1beta1
kind: SQL
name: test-198-11
spec:
    metadata:
        name: SQL
        operation: PrepareContext.NumInput
        type: SQL_DB
    type: int
    int: 2
    error: []
---
version: api.keploy.io/v1beta1
kind: SQL
name: test-198-12
spec:
    metadata:
        arguments: '[{ 1 12} { 2 <nil>}]'
        name: SQL
        operation: QueryContext
        type: SQL_DB
    type: error
    int: 0
    error:
        - nil
---
version: api.keploy.io/v1beta1
kind: SQL
name: test-198-13
spec:
    metadata:
        name: SQL
        operation: QueryContext.Close
        type: SQL_DB
    type: table
    table:
        cols:
            - name: id
              type: int64
              precision: 0
              scale: 0
            - name: uuid
              type: '[]uint8'
              precision: 0
              scale: 0
            - name: name
              type: string
              precision: 0
              scale: 0
            - name: subject
              type: string
              precision: 0
              scale: 0
            - name: from_email
              type: string
              precision: 0
              scale: 0
            - name: body
              type: string
              precision: 0
              scale: 0
            - name: altbody
              type: <nil>
              precision: 0
              scale: 0
            - name: content_type
              type: '[]uint8'
              precision: 0
              scale: 0
            - name: send_at
              type: <nil>
              precision: 0
              scale: 0
            - name: headers
              type: '[]uint8'
              precision: 0
              scale: 0
            - name: status
              type: '[]uint8'
              precision: 0
              scale: 0
            - name: tags
              type: <nil>
              precision: 0
              scale: 0
            - name: type
              type: '[]uint8'
              precision: 0
              scale: 0
            - name: messenger
              type: string
              precision: 0
              scale: 0
            - name: template_id
              type: int64
              precision: 0
              scale: 0
            - name: to_send
              type: int64
              precision: 0
              scale: 0
            - name: sent
              type: int64
              precision: 0
              scale: 0
            - name: max_subscriber_id
              type: int64
              precision: 0
              scale: 0
            - name: last_subscriber_id
              type: int64
              precision: 0
              scale: 0
            - name: started_at
              type: <nil>
              precision: 0
              scale: 0
            - name: created_at
              type: time.Time
              precision: 0
              scale: 0
            - name: updated_at
              type: time.Time
              precision: 0
              scale: 0
            - name: template_body
              type: string
              precision: 0
              scale: 0
        rows:
            - "[`12` | `[97 97 49 100 52 51 56 52 45 98 54 52 48 45 52 48 101 97 45 98 98 52 57 45 100 101 100 102 48 48 48 49 55 56 55 49]` | `sample-optin` | `sample-optin` | `ritik@keploy.io` | `\n\n<p>Hi {{.Subscriber.FirstName }}</p>\n<p>You have been added to the following lists:</p>\n<ul>\n    \n        \n            <li>Private list</li>\n        \n    \n</ul>\n<p>\n    <a class=\"button\" href=\"{{ OptinURL }}l=df69e33d-e1f4-4f9b-a53b-9e059396cf3a\">Confirm subscription</a>\n</p>\n` | `<nil>` | `[114 105 99 104 116 101 120 116]` | `<nil>` | `[91 93]` | `[100 114 97 102 116]` | `<nil>` | `[111 112 116 105 110]` | `email` | `1` | `0` | `0` | `0` | `0` | `<nil>` | `\"2022-12-23T10:29:13.799254Z\"` | `\"2022-12-23T10:29:13.799254Z\"` | `<!doctype html>\n<html>\n    <head>\n        <meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\">\n        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1, minimum-scale=1\">\n        <base target=\"_blank\">\n\n        <style>\n            body {\n                background-color: #F0F1F3;\n                font-family: 'Helvetica Neue', 'Segoe UI', Helvetica, sans-serif;\n                font-size: 15px;\n                line-height: 26px;\n                margin: 0;\n                color: #444;\n            }\n\n            pre {\n                background: #f4f4f4f4;\n                padding: 2px;\n            }\n\n            table {\n                width: 100%;\n                border: 1px solid #ddd;\n            }\n            table td {\n                border-color: #ddd;\n                padding: 5px;\n            }\n\n            .wrap {\n                background-color: #fff;\n                padding: 30px;\n                max-width: 525px;\n                margin: 0 auto;\n                border-radius: 5px;\n            }\n\n            .button {\n                background: #0055d4;\n                border-radius: 3px;\n                text-decoration: none !important;\n                color: #fff !important;\n                font-weight: bold;\n                padding: 10px 30px;\n                display: inline-block;\n            }\n            .button:hover {\n                background: #111;\n            }\n\n            .footer {\n                text-align: center;\n                font-size: 12px;\n                color: #888;\n            }\n                .footer a {\n                    color: #888;\n                    margin-right: 5px;\n                }\n\n            .gutter {\n                padding: 30px;\n            }\n\n            img {\n                max-width: 100%;\n                height: auto;\n            }\n\n            a {\n                color: #0055d4;\n            }\n                a:hover {\n                    color: #111;\n                }\n            @media screen and (max-width: 600px) {\n                .wrap {\n                    max-width: auto;\n                }\n                .gutter {\n                    padding: 10px;\n                }\n            }\n        </style>\n    </head>\n<body style=\"background-color: #F0F1F3;font-family: 'Helvetica Neue', 'Segoe UI', Helvetica, sans-serif;font-size: 15px;line-height: 26px;margin: 0;color: #444;\">\n    <div class=\"gutter\" style=\"padding: 30px;\">&nbsp;</div>\n    <div class=\"wrap\" style=\"background-color: #fff;padding: 30px;max-width: 525px;margin: 0 auto;border-radius: 5px;\">\n        {{ template \"content\" . }}\n    </div>\n    \n    <div class=\"footer\" style=\"text-align: center;font-size: 12px;color: #888;\">\n        <p>\n            {{ L.T \"email.unsubHelp\" }}\n            <a href=\"{{ UnsubscribeURL }}\" style=\"color: #888;\">{{ L.T \"email.unsub\" }}</a>\n            <a href=\"{{ MessageURL }}\" style=\"color: #888;\">{{ L.T \"email.viewInBrowser\" }}</a>\n        </p>\n        <p>Powered by <a href=\"https://listmonk.app\" target=\"_blank\" style=\"color: #888;\">listmonk</a></p>\n    </div>\n    <div class=\"gutter\" style=\"padding: 30px;\">&nbsp;{{ TrackView }}</div>\n</body>\n</html>\n` | ]"
            - "[`12` | `[97 97 49 100 52 51 56 52 45 98 54 52 48 45 52 48 101 97 45 98 98 52 57 45 100 101 100 102 48 48 48 49 55 56 55 49]` | `sample-optin` | `sample-optin` | `ritik@keploy.io` | `\n\n<p>Hi {{.Subscriber.FirstName }}</p>\n<p>You have been added to the following lists:</p>\n<ul>\n    \n        \n            <li>Private list</li>\n        \n    \n</ul>\n<p>\n    <a class=\"button\" href=\"{{ OptinURL }}l=df69e33d-e1f4-4f9b-a53b-9e059396cf3a\">Confirm subscription</a>\n</p>\n` | `<nil>` | `[114 105 99 104 116 101 120 116]` | `<nil>` | `[91 93]` | `[100 114 97 102 116]` | `<nil>` | `[111 112 116 105 110]` | `email` | `1` | `0` | `0` | `0` | `0` | `<nil>` | `\"2022-12-23T10:29:13.799254Z\"` | `\"2022-12-23T10:29:13.799254Z\"` | `<!doctype html>\n<html>\n    <head>\n        <meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\">\n        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1, minimum-scale=1\">\n        <base target=\"_blank\">\n\n        <style>\n            body {\n                background-color: #F0F1F3;\n                font-family: 'Helvetica Neue', 'Segoe UI', Helvetica, sans-serif;\n                font-size: 15px;\n                line-height: 26px;\n                margin: 0;\n                color: #444;\n            }\n\n            pre {\n                background: #f4f4f4f4;\n                padding: 2px;\n            }\n\n            table {\n                width: 100%;\n                border: 1px solid #ddd;\n            }\n            table td {\n                border-color: #ddd;\n                padding: 5px;\n            }\n\n            .wrap {\n                background-color: #fff;\n                padding: 30px;\n                max-width: 525px;\n                margin: 0 auto;\n                border-radius: 5px;\n            }\n\n            .button {\n                background: #0055d4;\n                border-radius: 3px;\n                text-decoration: none !important;\n                color: #fff !important;\n                font-weight: bold;\n                padding: 10px 30px;\n                display: inline-block;\n            }\n            .button:hover {\n                background: #111;\n            }\n\n            .footer {\n                text-align: center;\n                font-size: 12px;\n                color: #888;\n            }\n                .footer a {\n                    color: #888;\n                    margin-right: 5px;\n                }\n\n            .gutter {\n                padding: 30px;\n            }\n\n            img {\n                max-width: 100%;\n                height: auto;\n            }\n\n            a {\n                color: #0055d4;\n            }\n                a:hover {\n                    color: #111;\n                }\n            @media screen and (max-width: 600px) {\n                .wrap {\n                    max-width: auto;\n                }\n                .gutter {\n                    padding: 10px;\n                }\n            }\n        </style>\n    </head>\n<body style=\"background-color: #F0F1F3;font-family: 'Helvetica Neue', 'Segoe UI', Helvetica, sans-serif;font-size: 15px;line-height: 26px;margin: 0;color: #444;\">\n    <div class=\"gutter\" style=\"padding: 30px;\">&nbsp;</div>\n    <div class=\"wrap\" style=\"background-color: #fff;padding: 30px;max-width: 525px;margin: 0 auto;border-radius: 5px;\">\n        {{ template \"content\" . }}\n    </div>\n    \n    <div class=\"footer\" style=\"text-align: center;font-size: 12px;color: #888;\">\n        <p>\n            {{ L.T \"email.unsubHelp\" }}\n            <a href=\"{{ UnsubscribeURL }}\" style=\"color: #888;\">{{ L.T \"email.unsub\" }}</a>\n            <a href=\"{{ MessageURL }}\" style=\"color: #888;\">{{ L.T \"email.viewInBrowser\" }}</a>\n        </p>\n        <p>Powered by <a href=\"https://listmonk.app\" target=\"_blank\" style=\"color: #888;\">listmonk</a></p>\n    </div>\n    <div class=\"gutter\" style=\"padding: 30px;\">&nbsp;{{ TrackView }}</div>\n</body>\n</html>\n` | ]"
    int: 0
    error:
        - nil
        - EOF
        - nil
---
version: api.keploy.io/v1beta1
kind: SQL
name: test-198-14
spec:
    metadata:
        name: SQL
        operation: PrepareContext.Close
        type: SQL_DB
    type: error
    int: 0
    error:
        - nil
---
version: api.keploy.io/v1beta1
kind: SQL
name: test-198-15
spec:
    metadata:
        name: SQL
        operation: PrepareContext
        query: '"WITH lists AS ( SELECT campaign_id, JSON_AGG(JSON_BUILD_OBJECT(''id'', list_id, ''name'', list_name)) AS lists FROM campaign_lists WHERE campaign_id = ANY($1) GROUP BY campaign_id ), views AS ( SELECT campaign_id, COUNT(campaign_id) as num FROM campaign_views WHERE campaign_id = ANY($1) GROUP BY campaign_id ), clicks AS ( SELECT campaign_id, COUNT(campaign_id) as num FROM link_clicks WHERE campaign_id = ANY($1) GROUP BY campaign_id ), bounces AS ( SELECT campaign_id, COUNT(campaign_id) as num FROM bounces WHERE campaign_id = ANY($1) GROUP BY campaign_id ) SELECT id as campaign_id, COALESCE(v.num, 0) AS views, COALESCE(c.num, 0) AS clicks, COALESCE(b.num, 0) AS bounces, COALESCE(l.lists, ''[]'') AS lists FROM (SELECT id FROM UNNEST($1) AS id) x LEFT JOIN lists AS l ON (l.campaign_id = id) LEFT JOIN views AS v ON (v.campaign_id = id) LEFT JOIN clicks AS c ON (c.campaign_id = id) LEFT JOIN bounces AS b ON (b.campaign_id = id) ORDER BY ARRAY_POSITION($1, id);"'
        type: SQL_DB
    type: error
    int: 0
    error:
        - nil
---
version: api.keploy.io/v1beta1
kind: SQL
name: test-198-16
spec:
    metadata:
        name: SQL
        operation: PrepareContext.NumInput
        type: SQL_DB
    type: int
    int: 1
    error: []
---
version: api.keploy.io/v1beta1
kind: SQL
name: test-198-17
spec:
    metadata:
        arguments: '[{ 1 {12}}]'
        name: SQL
        operation: QueryContext
        type: SQL_DB
    type: error
    int: 0
    error:
        - nil
---
version: api.keploy.io/v1beta1
kind: SQL
name: test-198-18
spec:
    metadata:
        name: SQL
        operation: QueryContext.Close
        type: SQL_DB
    type: table
    table:
        cols:
            - name: campaign_id
              type: int64
              precision: 0
              scale: 0
            - name: views
              type: int64
              precision: 0
              scale: 0
            - name: clicks
              type: int64
              precision: 0
              scale: 0
            - name: bounces
              type: int64
              precision: 0
              scale: 0
            - name: lists
              type: '[]uint8'
              precision: 0
              scale: 0
        rows:
            - '[`12` | `0` | `0` | `0` | `[91 123 34 105 100 34 32 58 32 51 44 32 34 110 97 109 101 34 32 58 32 34 111 112 116 105 110 34 125 93]` | ]'
            - '[`12` | `0` | `0` | `0` | `[91 123 34 105 100 34 32 58 32 51 44 32 34 110 97 109 101 34 32 58 32 34 111 112 116 105 110 34 125 93]` | ]'
    int: 0
    error:
        - nil
        - EOF
        - nil
---
version: api.keploy.io/v1beta1
kind: SQL
name: test-198-19
spec:
    metadata:
        name: SQL
        operation: PrepareContext.Close
        type: SQL_DB
    type: error
    int: 0
    error:
        - nil
