version: api.keploy.io/v1beta1
kind: SQL
name: test-32-0
spec:
    metadata:
        name: SQL
        operation: PrepareContext
        query: '"WITH s AS ( UPDATE subscribers SET email=(CASE WHEN $2 != '''' THEN $2 ELSE email END), name=(CASE WHEN $3 != '''' THEN $3 ELSE name END), status=(CASE WHEN $4 != '''' THEN $4::subscriber_status ELSE status END), attribs=(CASE WHEN $5 != '''' THEN $5::JSONB ELSE attribs END), updated_at=NOW() WHERE id = $1 RETURNING id ), d AS ( DELETE FROM subscriber_lists WHERE subscriber_id = $1 AND list_id != ALL($6) ), listIDs AS ( SELECT id FROM lists WHERE (CASE WHEN CARDINALITY($6::INT[]) > 0 THEN id=ANY($6) ELSE uuid=ANY($7::UUID[]) END) ) INSERT INTO subscriber_lists (subscriber_id, list_id, status) VALUES( (SELECT id FROM s), UNNEST(ARRAY(SELECT id FROM listIDs)), (CASE WHEN $4=''blocklisted'' THEN ''unsubscribed''::subscription_status ELSE $8::subscription_status END) ) ON CONFLICT (subscriber_id, list_id) DO UPDATE SET status = (CASE WHEN $4=''blocklisted'' THEN ''unsubscribed''::subscription_status ELSE subscriber_lists.status END);"'
        type: SQL_DB
    type: error
    int: 0
    error:
        - nil
---
version: api.keploy.io/v1beta1
kind: SQL
name: test-32-1
spec:
    metadata:
        name: SQL
        operation: PrepareContext.NumInput
        type: SQL_DB
    type: int
    int: 8
    error: []
---
version: api.keploy.io/v1beta1
kind: SQL
name: test-32-2
spec:
    metadata:
        arguments: '[{ 1 18} { 2 gouravkrox@gmail.com} { 3 gourav kumar} { 4 enabled} { 5 [123 125]} { 6 {}} { 7 <nil>} { 8 unconfirmed}]'
        name: SQL
        operation: ExecContext
        type: SQL_DB
    type: error
    int: 0
    error:
        - nil
---
version: api.keploy.io/v1beta1
kind: SQL
name: test-32-3
spec:
    metadata:
        arguments: '[{ 1 18} { 2 gouravkrox@gmail.com} { 3 gourav kumar} { 4 enabled} { 5 [123 125]} { 6 {}} { 7 <nil>} { 8 unconfirmed}]'
        name: SQL
        operation: ExecContext.LastInsertId
        type: SQL_DB
    type: int
    int: 0
    error:
        - LastInsertId is not supported by this driver
---
version: api.keploy.io/v1beta1
kind: SQL
name: test-32-4
spec:
    metadata:
        arguments: '[{ 1 18} { 2 gouravkrox@gmail.com} { 3 gourav kumar} { 4 enabled} { 5 [123 125]} { 6 {}} { 7 <nil>} { 8 unconfirmed}]'
        name: SQL
        operation: ExecContext.RowsAffected
        type: SQL_DB
    type: int
    int: 0
    error:
        - nil
---
version: api.keploy.io/v1beta1
kind: SQL
name: test-32-5
spec:
    metadata:
        name: SQL
        operation: PrepareContext.Close
        type: SQL_DB
    type: error
    int: 0
    error:
        - nil
---
version: api.keploy.io/v1beta1
kind: SQL
name: test-32-6
spec:
    metadata:
        name: SQL
        operation: PrepareContext
        query: '"SELECT * FROM subscribers WHERE CASE WHEN $1 > 0 THEN id = $1 WHEN $2 != '''' THEN uuid = $2::UUID WHEN $3 != '''' THEN email = $3 END;"'
        type: SQL_DB
    type: error
    int: 0
    error:
        - nil
---
version: api.keploy.io/v1beta1
kind: SQL
name: test-32-7
spec:
    metadata:
        name: SQL
        operation: PrepareContext.NumInput
        type: SQL_DB
    type: int
    int: 3
    error: []
---
version: api.keploy.io/v1beta1
kind: SQL
name: test-32-8
spec:
    metadata:
        arguments: '[{ 1 18} { 2 <nil>} { 3 gouravkrox@gmail.com}]'
        name: SQL
        operation: QueryContext
        type: SQL_DB
    type: error
    int: 0
    error:
        - nil
---
version: api.keploy.io/v1beta1
kind: SQL
name: test-32-9
spec:
    metadata:
        name: SQL
        operation: QueryContext.Close
        type: SQL_DB
    type: table
    table:
        cols:
            - name: id
              type: int64
              precision: 0
              scale: 0
            - name: uuid
              type: '[]uint8'
              precision: 0
              scale: 0
            - name: email
              type: string
              precision: 0
              scale: 0
            - name: name
              type: string
              precision: 0
              scale: 0
            - name: attribs
              type: '[]uint8'
              precision: 0
              scale: 0
            - name: status
              type: '[]uint8'
              precision: 0
              scale: 0
            - name: created_at
              type: time.Time
              precision: 0
              scale: 0
            - name: updated_at
              type: time.Time
              precision: 0
              scale: 0
        rows:
            - '[`18` | `[54 102 55 98 55 101 54 51 45 54 49 50 54 45 52 51 98 97 45 97 55 53 102 45 52 55 53 51 52 97 48 56 55 57 56 52]` | `gouravkrox@gmail.com` | `gourav kumar` | `[123 125]` | `[101 110 97 98 108 101 100]` | `"2022-11-09T06:52:16.4999Z"` | `"2022-12-18T11:37:13.217523Z"` | ]'
            - '[`18` | `[54 102 55 98 55 101 54 51 45 54 49 50 54 45 52 51 98 97 45 97 55 53 102 45 52 55 53 51 52 97 48 56 55 57 56 52]` | `gouravkrox@gmail.com` | `gourav kumar` | `[123 125]` | `[101 110 97 98 108 101 100]` | `"2022-11-09T06:52:16.4999Z"` | `"2022-12-18T11:37:13.217523Z"` | ]'
    int: 0
    error:
        - nil
        - EOF
        - nil
---
version: api.keploy.io/v1beta1
kind: SQL
name: test-32-10
spec:
    metadata:
        name: SQL
        operation: PrepareContext.Close
        type: SQL_DB
    type: error
    int: 0
    error:
        - nil
---
version: api.keploy.io/v1beta1
kind: SQL
name: test-32-11
spec:
    metadata:
        name: SQL
        operation: PrepareContext
        query: '"WITH subs AS ( SELECT subscriber_id, JSON_AGG( ROW_TO_JSON( (SELECT l FROM (SELECT subscriber_lists.status AS subscription_status, lists.*) l) ) ) AS lists FROM lists LEFT JOIN subscriber_lists ON (subscriber_lists.list_id = lists.id) WHERE subscriber_lists.subscriber_id = ANY($1) GROUP BY subscriber_id ) SELECT id as subscriber_id, COALESCE(s.lists, ''[]'') AS lists FROM (SELECT id FROM UNNEST($1) AS id) x LEFT JOIN subs AS s ON (s.subscriber_id = id) ORDER BY ARRAY_POSITION($1, id);"'
        type: SQL_DB
    type: error
    int: 0
    error:
        - nil
---
version: api.keploy.io/v1beta1
kind: SQL
name: test-32-12
spec:
    metadata:
        name: SQL
        operation: PrepareContext.NumInput
        type: SQL_DB
    type: int
    int: 1
    error: []
---
version: api.keploy.io/v1beta1
kind: SQL
name: test-32-13
spec:
    metadata:
        arguments: '[{ 1 {18}}]'
        name: SQL
        operation: QueryContext
        type: SQL_DB
    type: error
    int: 0
    error:
        - nil
---
version: api.keploy.io/v1beta1
kind: SQL
name: test-32-14
spec:
    metadata:
        name: SQL
        operation: QueryContext.Close
        type: SQL_DB
    type: table
    table:
        cols:
            - name: subscriber_id
              type: int64
              precision: 0
              scale: 0
            - name: lists
              type: '[]uint8'
              precision: 0
              scale: 0
        rows:
            - '[`18` | `[91 93]` | ]'
            - '[`18` | `[91 93]` | ]'
    int: 0
    error:
        - nil
        - EOF
        - nil
---
version: api.keploy.io/v1beta1
kind: SQL
name: test-32-15
spec:
    metadata:
        name: SQL
        operation: PrepareContext.Close
        type: SQL_DB
    type: error
    int: 0
    error:
        - nil
